<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PropDecoded • Investor Lens (Heat Map → Dashboard)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script defer src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<!-- Chart.js -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
:root{
  --green:#1F6F63; --green-700:#0E3F38; --green-600:#15574E; --green-100:#E9F6F0;
  --ink:#163330; --muted:#6A7D80; --card:#FFFFFF; --bg:#0F2E29;
  --shadow: 0 6px 14px rgba(12,35,31,.18);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#0C2420,var(--bg));color:var(--ink)}
.wrap{max-width:1180px;margin:0 auto;padding:20px 18px 80px}
.topbar{display:flex;align-items:center;gap:12px;color:#EAF3F1;margin-top:8px}
.logo{width:40px;height:40px;border-radius:11px;background:linear-gradient(135deg,#2C8D7C,#14594F);display:grid;place-items:center;box-shadow:var(--shadow);color:#fff;font-weight:800}
h1{margin:0;font-size:28px;letter-spacing:.5px;color:#EAF3F1}
.muted{color:#97b5b0}

/* Step 1: picker */
.picker{margin-top:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;color:#EAF3F1}
.picker-head{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border-radius:999px;padding:10px 14px;border:2px solid var(--green);background:#fff;color:var(--green-700);font-weight:700;cursor:pointer}
#map{width:100%;height:420px;border-radius:14px;margin-top:12px;overflow:hidden}

/* Step 2: dashboard */
.panel{margin-top:18px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;color:#EAF3F1}
.kblock{background:var(--card);border-radius:14px;padding:10px 12px;display:flex;gap:10px;align-items:center}
.num{font-weight:800;font-size:22px;color:var(--green-600)}
.meter{height:10px;background:#E8EEED;border-radius:999px;overflow:hidden}
.meter>i{display:block;height:100%;background:linear-gradient(90deg,#2C8D7C,#78C9BC)}
.grid{display:grid;gap:14px;margin-top:14px;grid-template-columns:1fr}
@media(min-width:760px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1024px){.grid{grid-template-columns:repeat(3,1fr)}}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:14px;min-height:180px;display:flex;flex-direction:column;gap:10px}
.card h3{margin:0;font-size:16px;color:var(--ink)}
.card small{color:var(--muted)}
.card .split{display:grid;grid-template-columns:1fr 1fr;gap:10px}
canvas{width:100% !important;height:180px !important}
.mini-map{flex:1;min-height:160px;border-radius:12px;background:#E8EEED;display:grid;place-items:center;color:#567;text-align:center}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{border-bottom:1px solid #EDF2F1;padding:8px 6px;text-align:left}
.table th{color:#567;font-weight:700}
.foot{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:12px;margin-top:12px;color:#6A7D80;font-size:13px}
.hidden{display:none}

/* Custom dropdown (white bg, green text) */
.dd{position:relative;display:inline-block;min-width:220px}
.dd-btn{
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  width:100%;padding:10px 14px;border-radius:999px;border:2px solid var(--green);
  background:#fff;color:var(--green-700);font-weight:700;cursor:pointer
}
.dd-btn svg{color:inherit}
.dd-btn:focus{outline:none;box-shadow:0 0 0 3px rgba(31,111,99,.18)}
.dd-list{
  position:absolute;left:0;right:0;top:100%;margin-top:8px;list-style:none;padding:6px;border-radius:12px;
  border:1px solid rgba(0,0,0,.12);background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.15);
  display:none;z-index:9999;
}
.dd.open .dd-list{display:block}
.dd-list li{padding:10px 14px;cursor:pointer;border-radius:6px;color:var(--green-700);background:#fff}
.dd-list li:hover{background:var(--green-100)}
.dd-list li[aria-selected="true"]{background:var(--green);color:#fff}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">P</div>
    <div>
      <h1>PropDecoded • Investor Lens</h1>
      <div class="muted">เลือกย่านจาก Heat Map เพื่อดูข้อมูลเชิงลึก</div>
    </div>
  </div>

  <!-- STEP 1: AREA PICKER -->
  <section id="areaPicker" class="picker">
    <div class="picker-head">
      <div class="muted">Heat Map แสดง “ความหนาแน่นกิจกรรมตลาดโดยประมาณ” (ตัวอย่าง)</div>
      <div class="controls">
        <!-- Custom dropdown -->
        <div class="dd" id="areaDropdown" data-value="sukhumvit">
          <button type="button" class="dd-btn" aria-haspopup="listbox" aria-expanded="false">
            <span class="dd-label" id="ddLabel">Sukhumvit</span>
            <svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
          </button>
          <ul class="dd-list" role="listbox" tabindex="-1">
            <li role="option" data-value="sukhumvit" aria-selected="true">Sukhumvit</li>
            <li role="option" data-value="ekkamai">Ekkamai</li>
            <li role="option" data-value="thonglor">Thonglor</li>
            <li role="option" data-value="phromphong">Phrom Phong</li>
            <li role="option" data-value="onnut">On Nut</li>
            <li role="option" data-value="ratchada">Ratchada</li>
          </ul>
        </div>
        <button id="goBtn" class="btn">ดูข้อมูลย่านนี้</button>
      </div>
    </div>
    <div id="map" role="img" aria-label="Heat Map of Bangkok areas"></div>
  </section>

  <!-- STEP 2: DASHBOARD -->
  <section id="dashboard" class="hidden">
    <div class="panel">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div class="muted">พื้นที่: <b id="areaName">—</b></div>
        <button class="btn" onclick="goBack()">← เลือกย่านใหม่</button>
      </div>
      <div style="height:10px"></div>
      <div class="meter"><i id="oppBar" style="width:0%"></i></div>
      <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
        <div class="kblock"><small class="muted">Yield proxy</small><span class="num" id="yieldNum">—</span></div>
        <div class="kblock"><small class="muted">Cap rate</small><span class="num" id="capNum">—</span></div>
        <div class="kblock"><small class="muted">Resilience</small><span class="num" id="resilienceTxt">—</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Demand &amp; Liquidity</h3>
        <small>Take-up Rate (10-Year)</small>
        <canvas id="takeupChart"></canvas>
        <div class="split">
          <div>
            <small class="muted">Absorption Units</small>
            <canvas id="absorbChart"></canvas>
          </div>
          <div>
            <small class="muted">Overhang Units</small>
            <div style="display:flex;gap:10px;align-items:center"><span class="num" id="overhangNum">—</span><small class="muted">ยูนิต</small></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Supply &amp; Pipeline</h3>
        <div class="split">
          <div><small class="muted">New Projects</small><canvas id="newProjectChart"></canvas></div>
          <div><small class="muted">Top Developers</small><canvas id="devPie"></canvas></div>
        </div>
      </div>

      <div class="card">
        <h3>Rental Performance</h3>
        <small>Yield &amp; Cap Rate</small>
        <canvas id="rentalChart"></canvas>
      </div>

      <div class="card">
        <h3>Price Metrics</h3>
        <small>Launch vs Resale (10-Year)</small>
        <canvas id="priceChart"></canvas>
        <div class="split">
          <div class="kblock"><small class="muted">Launch (avg.)</small><span class="num" id="launchNum">—</span><small>/ตร.ม.</small></div>
          <div class="kblock"><small class="muted">Resale (avg.)</small><span class="num" id="resaleNum">—</span><small>/ตร.ม.</small></div>
        </div>
      </div>

      <div class="card">
        <h3>Benchmark &amp; Comparison</h3>
        <div class="split">
          <div class="mini-map">Map A<br><small class="muted">เปรียบเทียบย่านใกล้เคียง</small></div>
          <div class="mini-map">Map B<br><small class="muted">โครงข่ายขนส่ง</small></div>
        </div>
      </div>

      <div class="card">
        <h3>Macro &amp; Context</h3>
        <div class="mini-map">แผนที่บริบทมหภาค (placeholder)</div>
      </div>

      <div class="card">
        <h3>Benchmark &amp; Comparison</h3>
        <table class="table">
          <thead><tr><th>พื้นที่</th><th>ราคา/ตร.ม.</th><th>Yield</th><th>Cap</th></tr></thead>
          <tbody id="benchTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="foot">
      Sources: REIC, CBRE, Knight Frank • Disclaimer: For reference only, not investment advice.
    </div>
  </section>
</div>

<script>
// ------- Demo data -------
  const AREAS = {
  sukhumvit:{ center:[13.7336,100.5760],
    heat:[[13.732,100.572,0.9],[13.735,100.581,0.8],[13.728,100.583,0.7],[13.739,100.575,0.65]],
    investorMeta:{ meter:0.72, yield:5.6, cap:4.2, resilience:"ดี" },
    takeup:{ years:Array.from({length:10},(_,i)=>2015+i), rate:[64,62,65,66,69,71,68,72,74,76]},
    absorption:[320,380,420,450,520,610,680,720,650,600],
    overhang:1800,
    newProjects:[5,8,6,10,13,7,4,6,9,11],
    topDevs:{ names:["Dev A","Dev B","Dev C"], share:[42,33,25] },
    rental:{ years:[2019,2020,2021,2022,2023,2024], yield:[4.3,4.1,4.6,4.9,5.2,5.6], cap:[3.8,3.6,3.7,3.9,4.0,4.2] },
    price:{ years:Array.from({length:10},(_,i)=>2015+i), launch:[110,112,114,117,120,124,126,129,134,139], resale:[95,98,102,107,112,118,125,131,138,145], avgLaunch:120000, avgResale:145000 },
    bench:[{area:"Ekkamai",price:152000,yield:5.4,cap:4.1},{area:"Thonglor",price:178000,yield:5.1,cap:3.9},{area:"Phrom Phong",price:165000,yield:5.3,cap:4.0},{area:"On Nut",price:125000,yield:5.8,cap:4.4}]
  },
  ekkamai:{ center:[13.7292,100.5902], heat:[[13.729,100.592,0.9],[13.727,100.586,0.6],[13.731,100.589,0.7]] },
  thonglor:{ center:[13.7337,100.5833], heat:[[13.734,100.582,0.8],[13.732,100.585,0.7]] },
  phromphong:{ center:[13.7308,100.5711], heat:[[13.732,100.571,0.75],[13.729,100.572,0.6]] },
  onnut:{ center:[13.7057,100.6069], heat:[[13.706,100.607,0.85],[13.704,100.604,0.5]] },
  ratchada:{ center:[13.7682,100.5736], heat:[[13.766,100.573,0.8],[13.770,100.575,0.65],[13.765,100.568,0.55]] }
};
["ekkamai","thonglor","phromphong","onnut","ratchada"].forEach(k=>{
  const base = JSON.parse(JSON.stringify(AREAS.sukhumvit));
  const tweak = { meter: Math.max(0.4, Math.min(0.9, 0.65+(Math.random()*0.1-0.05))),
    yield:+(5.3+Math.random()*0.6).toFixed(1), cap:+(3.8+Math.random()*0.6).toFixed(1),
    overhang:Math.round(1500+Math.random()*600), avgLaunch:110000+Math.round(Math.random()*40000),
    avgResale:120000+Math.round(Math.random()*50000) };
  AREAS[k].investorMeta={ meter:tweak.meter,yield:tweak.yield,cap:tweak.cap,resilience:"ดี" };
  AREAS[k].takeup=base.takeup;
  AREAS[k].absorption=base.absorption.map(v=>Math.round(v*(0.9+Math.random()*0.2)));
  AREAS[k].overhang=tweak.overhang;
  AREAS[k].newProjects=base.newProjects.map(v=>Math.max(3,Math.round(v*(0.8+Math.random()*0.4))));
  AREAS[k].topDevs=base.topDevs;
  AREAS[k].rental=base.rental;
  AREAS[k].price={...base.price,avgLaunch:tweak.avgLaunch,avgResale:tweak.avgResale};
  AREAS[k].bench=base.bench;
});

// ------- Map -------
let map, heatLayer, currentAreaKey="sukhumvit";
function initMap(){
  map=L.map('map',{zoomControl:false,attributionControl:false}).setView(AREAS.sukhumvit.center,13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  heatLayer=L.heatLayer(AREAS.sukhumvit.heat,{radius:28,blur:18,maxZoom:17}).addTo(map);
}
function updateHeat(key){ currentAreaKey=key; const a=AREAS[key]; map.setView(a.center,13); heatLayer.setLatLngs(a.heat); }
function goBack(){ document.getElementById('dashboard').classList.add('hidden'); document.getElementById('areaPicker').classList.remove('hidden'); setTimeout(()=>map.invalidateSize(),50); }

// ------- Custom dropdown -------
function initAreaDropdown(){
  const root=document.getElementById('areaDropdown');
  const btn=root.querySelector('.dd-btn'); const list=root.querySelector('.dd-list'); const label=root.querySelector('#ddLabel');
  let value=root.dataset.value||'sukhumvit';
  const setValue=(val)=>{ value=val; root.dataset.value=val;
    [...list.children].forEach(li=>li.setAttribute('aria-selected','false'));
    const active=[...list.children].find(li=>li.dataset.value===val);
    if(active){ active.setAttribute('aria-selected','true'); label.textContent=active.textContent.trim(); }
    if(typeof root.onChange==='function') root.onChange(val);
  };
  const open=()=>{ root.classList.add('open'); btn.setAttribute('aria-expanded','true'); };
  const close=()=>{ root.classList.remove('open'); btn.setAttribute('aria-expanded','false'); };
  btn.addEventListener('click',()=> root.classList.contains('open')?close():open());
  list.addEventListener('click',e=>{ const li=e.target.closest('li[role="option"]'); if(!li) return; setValue(li.dataset.value); close(); });
  document.addEventListener('click',e=>{ if(!root.contains(e.target)) close(); });
  setValue(value);
  return { get value(){return value;}, onChange:(fn)=> (root.onChange=fn) };
}

// ------- Dashboard -------
let CH={};
function showDashboard(key){
  const a=AREAS[key];
  document.getElementById('areaPicker').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('areaName').textContent=key.replace(/^[a-z]/,m=>m.toUpperCase()).replace('phrom','Phrom ');
  document.getElementById('oppBar').style.width=(a.investorMeta.meter*100).toFixed(0)+'%';
  document.getElementById('yieldNum').textContent=a.investorMeta.yield+'%';
  document.getElementById('capNum').textContent=a.investorMeta.cap+'%';
  document.getElementById('resilienceTxt').textContent=a.investorMeta.resilience;
  document.getElementById('overhangNum').textContent=a.overhang.toLocaleString();
  document.getElementById('launchNum').textContent=a.price.avgLaunch.toLocaleString();
  document.getElementById('resaleNum').textContent=a.price.avgResale.toLocaleString();
  const tbody=document.getElementById('benchTbody'); tbody.innerHTML='';
  a.bench.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.area}</td><td>${r.price.toLocaleString()}</td><td>${r.yield}%</td><td>${r.cap}%</td>`; tbody.appendChild(tr); });
  const make=(id,cfg)=>{ if(CH[id]) CH[id].destroy(); CH[id]=new Chart(document.getElementById(id),cfg); };
  make('takeupChart',{type:'line',data:{labels:a.takeup.years,datasets:[{data:a.takeup.rate,tension:.35,fill:false}]},options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>v+'%'}}}}});
  make('absorbChart',{type:'bar',data:{labels:a.takeup.years,datasets:[{data:a.absorption}]} ,options:{plugins:{legend:{display:false}}}});
  make('newProjectChart',{type:'bar',data:{labels:a.takeup.years,datasets:[{data:a.newProjects}]},options:{plugins:{legend:{display:false}}}});
  make('devPie',{type:'doughnut',data:{labels:a.topDevs.names,datasets:[{data:a.topDevs.share}]} ,options:{plugins:{legend:{position:'bottom'}},cutout:'60%'}});
  make('rentalChart',{type:'bar',data:{labels:a.rental.years,datasets:[{label:'Yield',data:a.rental.yield},{label:'Cap',data:a.rental.cap}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{ticks:{callback:v=>v+'%'}}}}});
  make('priceChart',{type:'line',data:{labels:a.price.years,datasets:[{label:'Launch',data:a.price.launch,tension:.35},{label:'Resale',data:a.price.resale,tension:.35}]},options:{plugins:{legend:{position:'bottom'}},scales:{y:{ticks:{callback:v=>v+'k'}}}}});
}

// ------- Boot -------
window.addEventListener('load',()=>{
  initMap();
  const areaDD=initAreaDropdown();
  areaDD.onChange(val=>updateHeat(val));
  document.getElementById('goBtn').addEventListener('click',()=>showDashboard(document.getElementById('areaDropdown').dataset.value));
});
</script>
</body>
</html>
