<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PropDecoded ‚Ä¢ Safe Mode</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<style>
  :root{
    --green:#2E7D5B; --green-100:#E9F6F0; --green-300:#BFE3D2;
    --teal:#1F6F63; --yellow:#F5E29E; --ink:#12333A; --muted:#4B5B5F;
    --card:#ffffff; --border:#E5EFE9; --shadow:0 8px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Prompt",Arial,sans-serif;background:linear-gradient(180deg,var(--green-100),#F7FAF9);color:var(--ink)}
  .container{max-width:1120px;margin:0 auto;padding:16px 20px 80px}
  .header{display:flex;align-items:center;gap:12px;padding:6px 0 10px;font-weight:800}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--teal));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
  h1{margin:8px 0 12px}

  .quick-grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media(min-width:900px){.quick-grid{grid-template-columns:repeat(4,1fr)}}
  .qcard{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;border:none}
  .qicon{width:36px;height:36px;border-radius:10px;background:var(--green-300);display:grid;place-items:center;font-weight:900;color:#1F6F63}
  .hint{color:#6A7D80;font-size:13px;margin-top:2px}

  .lens-bar{margin:18px 0 12px;display:flex;gap:8px;flex-wrap:wrap;position:relative;z-index:5}
  .seg{border:2px solid var(--green);border-radius:999px;padding:4px;display:inline-flex;gap:6px;background:#fff;box-shadow:var(--shadow)}
  .seg button{all:unset;padding:8px 14px;border-radius:999px;color:var(--green);font-weight:700;cursor:pointer}
  .seg button.active{background:linear-gradient(180deg,#D6EFE3,#fff);color:var(--ink);box-shadow:inset 0 0 0 2px rgba(255,255,255,.6)}

  .main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;align-items:start}
  @media(max-width:920px){.main{grid-template-columns:1fr}}

  #map{height:56vh;min-height:320px;border-radius:16px;box-shadow:var(--shadow)}
  .insight{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px 16px 10px}
  .badge{display:inline-block;background:#BFE3D2;color:#1F6F63;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;margin-right:6px}
  .meter{height:10px;background:#ECF2F3;border-radius:999px;overflow:hidden}
  .meter>span{display:block;height:100%;background:linear-gradient(90deg,#CFEBDD,var(--yellow));width:40%}
  .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
  .kpi .card{background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:12px}
  .muted{color:var(--muted)} details{background:#FAFCFB;border:1.5px solid var(--border);border-radius:12px;padding:10px 12px;margin:6px 0}

  /* Renovator dashboard (light) */
  #renovatorDash{display:none;height:56vh;min-height:320px}
  .reno-wrap{height:100%;background:#fff;color:var(--ink);border-radius:16px;box-shadow:var(--shadow);padding:16px;overflow:auto}
  .reno-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media(max-width:900px){.reno-grid{grid-template-columns:1fr}}
  .reno-card{background:#fff;border:1.5px solid var(--border);border-radius:14px;padding:14px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:6px 0 10px}
  .kpiD{background:#fff;border:1.5px solid var(--border);border-radius:12px;padding:10px}
  .kpiD .lab{font-size:12px;color:#4B5B5F}
  .kpiD .val{font-size:22px;margin-top:2px;color:var(--ink)}
  .pos{color:#2E7D5B}.neg{color:#d44a54}
  .canvas{height:260px}
  .badge-green{display:inline-block;background:#BFE3D2;color:#1F6F63;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;margin:8px 0}
  .range-wrap{font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai';margin:8px 0}
  .range-title{margin-bottom:6px;color:#12333A;font-weight:700}
  .range-bar{position:relative;height:28px;border-radius:14px;overflow:hidden;background:linear-gradient(90deg,#2E7D5B 0%, #F5E29E 50%, #d44a54 100%);box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
  .range-frame{position:absolute;inset:0;border:2px solid #fff;border-radius:14px;pointer-events:none}
  .range-marker{position:absolute;top:50%;transform:translate(-50%,-50%);width:12px;height:12px;border-radius:50%;background:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
  .range-tag{position:absolute;transform:translate(-50%,8px);background:#eef2ff;color:#1e40af;font-size:12px;padding:3px 8px;border-radius:999px;white-space:nowrap}
  .range-labels{display:flex;justify-content:space-between;color:#4B5B5F;font-size:12px;margin-top:4px}
  .range-note{font-size:12px;color:#4B5B5F;margin-top:4px}

  /* ‡∏Å‡∏±‡∏ô overlay ‡∏°‡∏≤‡∏ó‡∏±‡∏ö‡πÄ‡∏•‡∏ô‡∏™‡πå */
  .lens-bar, .seg, .seg button { pointer-events:auto }
</style>
</head>
<body>
  <div class="container">
    <header class="header"><div class="logo">PD</div> PropDecoded</header>
    <h1>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h1>

    <section class="quick-grid" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πà‡∏ß‡∏ô">
      <button class="qcard"><div class="qicon">‚û§</div><div><div class="qtitle">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><div class="hint">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏ô‡∏™‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à</div></div></button>
      <button class="qcard"><div class="qicon">‚åÅ</div><div><div class="qtitle">‡∏ö‡∏ó‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div><div class="hint">‡∏≠‡πà‡∏≤‡∏ô insight ‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏™‡∏£‡∏£</div></div></button>
      <button class="qcard"><div class="qicon">¬ß</div><div><div class="qtitle">‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏£‡∏≤‡∏ö</div><div class="hint">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à</div></div></button>
      <button class="qcard"><div class="qicon">‚òé</div><div><div class="qtitle">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤</div><div class="hint">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</div></div></button>
    </section>

    <section class="lens-bar">
      <div class="seg" role="tablist" aria-label="‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
        <button class="active" id="lens-tenant" role="tab" aria-selected="true">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</button>
        <button id="lens-investor" role="tab" aria-selected="false">‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô</button>
        <button id="lens-renovator" role="tab" aria-selected="false">‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó/‡∏î‡∏µ‡πÄ‡∏ß‡∏•‡∏≠‡∏õ</button>
      </div>
    </section>

    <section class="main">
      <div>
        <div id="map" aria-label="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"></div>

        <div id="renovatorDash">
          <div class="reno-wrap">
            <h2 class="reno-title">Investor Portfolio</h2>
            <div class="kpis">
              <div class="kpiD"><div class="lab">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô</div><div id="kpiI" class="val">‚Äì</div></div>
              <div class="kpiD"><div class="lab">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div id="kpiU" class="val">‚Äì</div></div>
              <div class="kpiD"><div class="lab">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°</div><div id="kpiN" class="val">‚Äì</div></div>
            </div>
            <div class="reno-grid">
              <div class="reno-card">
                <h4 style="margin:0 0 8px">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏£‡∏≤‡∏¢ (Donut)</h4>
                <div class="canvas"><canvas id="donut"></canvas></div>
                <span class="badge-green">Developer Benchmarks</span>
                <div id="benchMarket"></div>
                <div id="benchOwner"></div>
              </div>
              <div class="reno-card">
                <h4 style="margin:0 0 8px">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢ (Bar)</h4>
                <div class="canvas"><canvas id="barV"></canvas></div>
                <div class="muted" style="margin-top:6px">‡πÅ‡∏ó‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏Å‡∏≥‡πÑ‡∏£ ‚Ä¢ ‡πÅ‡∏ó‡πà‡∏á‡πÅ‡∏î‡∏á = ‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <aside class="insight">
        <span class="badge" id="lensTag">‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</span>
        <h3 id="areaTitle">‡∏ß‡∏±‡∏í‡∏ô‡∏≤</h3>
        <div class="muted" id="subtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏≠‡∏≤‡∏®‡∏±‡∏¢</div>
        <div style="margin:12px 0 6px;font-weight:800">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏´‡∏•‡∏±‡∏Å</div>
        <div class="meter"><span id="meterFill" style="width:60%"></span></div>
        <div class="kpi">
          <div class="card"><h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πà‡∏≠</h4><div class="muted" id="kpiLeftDesc">CBD ~ 18 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ BTS ~ 6 ‡∏ô‡∏≤‡∏ó‡∏µ</div></div>
          <div class="card"><h4 id="kpiRightTitle">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4><div class="muted" id="kpiRightDesc">‚Äú‡∏¢‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏Å‡∏•‡πâ ‡πÜ‚Äù</div></div>
        </div>
        <details open><summary>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</summary>
          <p class="muted" id="detailsText">‚Ä¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON</p>
        </details>
      </aside>
    </section>
  </div>

<script>
'use strict';

window.addEventListener('load', () => {
  const log = (...a)=>console.log('[PD]',...a);
  const showError = (msg)=>{ console.error(msg); alert('Error: '+msg); };

  // Elements
  const mapEl = document.getElementById('map');
  const renoEl = document.getElementById('renovatorDash');
  const lensBtns = {
    tenant: document.getElementById('lens-tenant'),
    investor: document.getElementById('lens-investor'),
    renovator: document.getElementById('lens-renovator'),
  };

  // Right pane refs
  const lensTag=document.getElementById('lensTag'), subtitle=document.getElementById('subtitle'),
        meterFill=document.getElementById('meterFill'),
        kpiLeftDesc=document.getElementById('kpiLeftDesc'),
        kpiRightTitle=document.getElementById('kpiRightTitle'),
        kpiRightDesc=document.getElementById('kpiRightDesc'),
        detailsText=document.getElementById('detailsText');

  const fmt = n => Number(n).toLocaleString('th-TH');
  const soft = i => `hsl(${(i*137.508)%360} 70% 55%)`;

  // Safe map init
  function initMap(){
    if (!window.L) { showError('Leaflet ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Å‡πÄ‡∏ô‡πá‡∏ï/CDN'); return null; }
    try{
      const m = L.map(mapEl).setView([13.736717, 100.523186], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19, attribution:'&copy; OpenStreetMap'
      }).addTo(m);
      [[13.7307,100.5402,'Condo A'],[13.7425,100.5167,'Condo B'],[13.7253,100.5101,'Condo C']]
        .forEach(([lat,lng,label])=>L.marker([lat,lng]).addTo(m).bindPopup(label));
      return m;
    }catch(e){ showError('Map init failed: '+e.message); return null; }
  }

  // Bench renderer
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function renderRange(mount, data){
    mount.innerHTML=''; if(!data||!(data.min>0)||!(data.max>data.min)) return;
    const wrap=document.createElement('div'); wrap.className='range-wrap';
    const t=document.createElement('div'); t.className='range-title'; t.textContent=data.title||'‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤';
    const bar=document.createElement('div'); bar.className='range-bar';
    const frame=document.createElement('div'); frame.className='range-frame';
    const marker=document.createElement('div'); marker.className='range-marker';
    const tag=document.createElement('div'); tag.className='range-tag'; tag.textContent=`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${fmt(data.actual)} ${data.unit||''}`;
    const labels=document.createElement('div'); labels.className='range-labels';
    labels.innerHTML=`<span>${fmt(data.min)}</span><span>${fmt(data.max)}</span>`;
    const note=document.createElement('div'); note.className='range-note';
    bar.appendChild(frame); bar.appendChild(marker); bar.appendChild(tag);
    wrap.appendChild(t); wrap.appendChild(bar); wrap.appendChild(labels); wrap.appendChild(note);
    mount.appendChild(wrap);
    function position(){
      const rect=bar.getBoundingClientRect();
      const a=clamp(data.actual??data.min,data.min,data.max);
      const p=(a-data.min)/(data.max-data.min); const x=p*rect.width;
      marker.style.left=x+'px'; tag.style.left=x+'px';
      const mid=(data.min+data.max)/2, diff=((a-mid)/mid)*100;
      const zone=p<.33?'‡∏ä‡πà‡∏ß‡∏á‡∏•‡πà‡∏≤‡∏á':(p>.67?'‡∏ä‡πà‡∏ß‡∏á‡∏ö‡∏ô':'‡∏Å‡∏•‡∏≤‡∏á‡∏ä‡πà‡∏ß‡∏á');
      note.innerHTML=`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <b>${zone}</b> (‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏≤‡∏á ~${diff.toFixed(1)}%)`;
    }
    position(); window.addEventListener('resize',position);
  }

  // Charts
  let donutChart=null, barVChart=null;
  function renderRenovator(){
    if (!window.Chart){ showError('Chart.js ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î'); return; }
    const holdings=[
      {investor:'Alpha Fund',positions:[{pnl:15000},{pnl:-5000}]},
      {investor:'Beta Capital',positions:[{pnl:8000},{pnl:3000},{pnl:-2000}]},
      {investor:'Solo Investor',positions:[{pnl:12000}]},
      {investor:'Gamma Trust',positions:[{pnl:4000},{pnl:2000}]},
    ];
    const labels=holdings.map(h=>h.investor);
    const unitCounts=holdings.map(h=>h.positions.length);
    const profits=holdings.map(h=>h.positions.reduce((s,p)=>s+(Number(p.pnl)||0),0));
    const netTotal=profits.reduce((s,n)=>s+n,0);

    document.getElementById('kpiI').textContent=fmt(holdings.length);
    document.getElementById('kpiU').textContent=fmt(unitCounts.reduce((a,b)=>a+b,0));
    const kN=document.getElementById('kpiN'); kN.textContent=(netTotal>=0?'+':'‚Äì')+'‡∏ø'+fmt(Math.abs(netTotal));
    kN.classList.toggle('pos',netTotal>=0); kN.classList.toggle('neg',netTotal<0);

    donutChart&&donutChart.destroy();
    donutChart=new Chart(document.getElementById('donut'),{
      type:'doughnut',
      data:{labels,datasets:[{data:unitCounts,backgroundColor:labels.map((_,i)=>soft(i)),borderColor:'#fff',borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false,cutout:'55%',
        plugins:{legend:{position:'bottom',labels:{color:'#12333A',font:{weight:'bold'}}},
                 tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.raw} ‡∏´‡πâ‡∏≠‡∏á`}}}}
    });

    barVChart&&barVChart.destroy();
    barVChart=new Chart(document.getElementById('barV'),{
      type:'bar',
      data:{labels,datasets:[{label:'Net P/L (‡∏ö‡∏≤‡∏ó)',data:profits,backgroundColor:profits.map(v=>v>=0?'#2E7D5B':'#d44a54')}]},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{
          y:{beginAtZero:true,grid:{color:'rgba(18,51,58,0.12)'},ticks:{color:'#12333A',callback:v=>'‡∏ø'+fmt(v)}},
          x:{grid:{display:false},ticks:{color:'#12333A'}}
        },
        plugins:{legend:{display:false}}
      }
    });

    renderRange(document.getElementById('benchMarket'),{title:'‡∏ä‡πà‡∏ß‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î (‡∏¢‡∏π‡∏ô‡∏¥‡∏ï‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)',unit:'‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',min:18000,max:20000,actual:19000});
    renderRange(document.getElementById('benchOwner'), {title:'‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Developer)',unit:'‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',min:18500,max:20500,actual:19800});
  }

  // Right pane JSON (optional)
  async function loadLens(lens){
    try{
      const res=await fetch(`./${lens}.json?v=${Date.now()}`,{cache:'no-store'});
      if(!res.ok) throw 0;
      return await res.json();
    }catch{ return {}; }
  }

  // Lens apply
  async function applyLens(lens){
    Object.entries(lensBtns).forEach(([id,btn])=>{
      btn.classList.toggle('active', id===lens);
      btn.setAttribute('aria-selected', id===lens ? 'true' : 'false');
    });
    const isReno = (lens==='renovator');
    mapEl.style.display = isReno ? 'none' : 'block';
    renoEl.style.display = isReno ? 'block' : 'none';
    if (isReno) renderRenovator();

    const c = await loadLens(lens);
    document.getElementById('lensTag').textContent = c.tag || (isReno?'‡∏£‡∏µ‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó/‡∏î‡∏µ‡πÄ‡∏ß‡∏•‡∏≠‡∏õ':(lens==='investor'?'‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô':'‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤'));
    document.getElementById('subtitle').textContent = c.subtitle || (isReno ? '‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡πÄ‡∏î‡πÇ‡∏°‡πà)' : '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏≠‡∏≤‡∏®‡∏±‡∏¢');
    document.getElementById('meterFill').style.width = Math.round((c.meter ?? 0.6)*100)+'%';
    document.getElementById('kpiLeftDesc').textContent = c.kpiLeftDesc || 'CBD ~ 18 ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ BTS ~ 6 ‡∏ô‡∏≤‡∏ó‡∏µ';
    document.getElementById('kpiRightTitle').textContent= c.kpiRightTitle || '‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
    document.getElementById('kpiRightDesc').textContent = c.kpiRightDesc  || '‚Äú‡∏¢‡πà‡∏≤‡∏ô‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô ‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏Å‡∏•‡πâ ‡πÜ‚Äù';
    document.getElementById('detailsText').innerHTML   = c.detailsText   || '‚Ä¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå JSON';

    localStorage.setItem('pd_lens', lens);
  }

  // Bind buttons (robust)
  lensBtns.tenant?.addEventListener('click', ()=>applyLens('tenant'));
  lensBtns.investor?.addEventListener('click', ()=>applyLens('investor'));
  lensBtns.renovator?.addEventListener('click', ()=>applyLens('renovator'));

  // Boot
  const m = initMap();
  if (!m) log('Map failed to init');
  applyLens(localStorage.getItem('pd_lens') || 'tenant');
});
 // üëá Quick link to Investor Lens (auto-insert)
document.addEventListener('DOMContentLoaded', () => {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
  const link = document.createElement('a');
  link.href = 'index_investor.html?v=10';
  link.textContent = '‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏ô‡∏±‡∏Å‡∏•‡∏á‡∏ó‡∏∏‡∏ô (‡πÉ‡∏´‡∏°‡πà)‚Äù';
  link.style.cssText = `
    display:inline-block;margin:10px 0 0; padding:10px 14px;
    border-radius:999px; font-weight:700; text-decoration:none;
    background:#DDF3EE; color:#14594F; border:2px solid transparent;
  `;

  // ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ lens-bar ‡∏Å‡πá‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà container)
  const lensBar = document.querySelector('.lens-bar') || document.querySelector('.container');
  (lensBar || document.body).appendChild(link);
});
</script>
</body>
</html>
